# Add the cross compiler sources
RUN apt-get clean -y && apt-get update -y && apt-get install -y --no-install-recommends gnupg2

RUN apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 871920D1991BC93C 8D69674688B6CB36 B523E5F3FC4E5F2C

COPY scripts/ci/riscv64-cross/amd64-sources.list /etc/apt/sources.list

COPY scripts/ci/riscv64-cross/riscv64-sources.list /etc/apt/sources.list.d/

RUN dpkg --add-architecture ${DEBIAN_ARCH} && \
	apt-get update -y

ENV CROSS_COMPILE=${CROSS_TRIPLET}-				\
	CROSS_ROOT=/usr/${CROSS_TRIPLET}			\
	AS=/usr/bin/${CROSS_TRIPLET}-as				\
	AR=/usr/bin/${CROSS_TRIPLET}-ar				\
	CC=/usr/bin/${CROSS_TRIPLET}-gcc			\
	CPP=/usr/bin/${CROSS_TRIPLET}-cpp			\
	CXX=/usr/bin/${CROSS_TRIPLET}-g++			\
	LD=/usr/bin/${CROSS_TRIPLET}-ld				\
	FC=/usr/bin/${CROSS_TRIPLET}-gfortran

ENV PATH="${PATH}:${CROSS_ROOT}/bin"				\
	PKG_CONFIG_PATH=/usr/lib/${CROSS_TRIPLET}/pkgconfig

COPY . /criu
WORKDIR /criu

RUN contrib/dependencies/apt-cross-packages.sh

RUN make mrproper && date && make -j $(nproc) zdtm && date
