ARG CC=gcc

COPY . /criu
WORKDIR /criu

RUN contrib/apt-install "$CC" && contrib/dependencies/apt-packages.sh

RUN uname -m && setarch linux32 uname -m && setarch --list

RUN make mrproper && date && \
# Check single object build
	setarch linux32 make -j $(nproc) CC="$CC" criu/parasite-syscall.o && \
# Compile criu
	setarch linux32 make -j $(nproc) CC="$CC" && \
	date && \
# Check that "make mrproper" works
	setarch linux32 make mrproper && ! git clean -ndx --exclude=scripts/build \
	--exclude=.config --exclude=test | grep .

# Compile tests
RUN date && setarch linux32 make -j $(nproc) CC="$CC" -C test/zdtm && date

#RUN make test/compel/handle_binary && ./test/compel/handle_binary
